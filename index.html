<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>百家乐AI预测系统</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- ✅ Supabase JS（必须） -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;500;700&display=swap');

    :root {
      --primary: #4f46e5;
      --secondary: #ec4899;
      --dark: #1e293b;
      --light: #f8fafc;
    }

    body {
      font-family: 'Noto Sans SC', sans-serif;
      background-color: #f1f5f9;
      color: var(--dark);
      background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M30,10 Q50,5 70,10 T90,30 Q95,50 90,70 T70,90 Q50,95 30,90 T10,70 Q5,50 10,30 T30,10" fill="none" stroke="rgba(79,70,229,0.1)" stroke-width="1"/></svg>');
    }

    .hand-drawn-border {
      border: 2px solid var(--dark);
      border-radius: 255px 15px 225px 15px/15px 225px 15px 255px;
      box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
    }

    .hand-drawn-btn {
      border: 2px solid var(--dark);
      border-radius: 255px 15px 225px 15px/15px 225px 15px 255px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .hand-drawn-btn:hover {
      transform: translateY(-2px) rotate(-1deg);
      box-shadow: 3px 3px 0 rgba(0,0,0,0.2);
    }

    .hand-drawn-btn:active {
      transform: translateY(0) rotate(0);
    }

    .hand-drawn-btn::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.2);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }

    .hand-drawn-btn:hover::after {
      transform: translateX(0);
    }

    .title-font {
      font-family: 'Ma Shan Zheng', cursive;
      text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
    }

    .watercolor-bg {
      background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M20,20 Q30,10 40,20 T60,20 Q70,10 80,20 T100,40 Q90,50 100,60 T80,80 Q70,90 60,80 T40,80 Q30,90 20,80 T0,60 Q10,50 0,40 T20,20" fill="rgba(79,70,229,0.05)" stroke="none"/></svg>');
    }

    .cell {
      transition: all 0.3s ease;
      transform-style: preserve-3d;
    }

    .cell:hover {
      transform: scale(1.05) rotateY(10deg);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .animate-pulse {
      animation: pulse 2s infinite;
    }
  </style>
</head>

<body class="min-h-screen py-8">
  <div class="container mx-auto px-4 max-w-4xl">
    <div class="bg-white hand-drawn-border watercolor-bg p-6 mb-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="title-font text-3xl md:text-4xl text-indigo-600">百家乐AI预测系统</h1>
        <span id="connectionStatus" class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-red-100 text-red-800">未连接</span>
      </div>

      <div class="mb-6">
        <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-2">DeepSeek API密钥（此版本不需要，可留空）</label>
        <div class="relative">
          <input type="password" id="apiKeyInput"
            class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-200"
            placeholder="可留空">
          <button id="btnConnect"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-indigo-600 text-white px-4 py-1 rounded-lg hand-drawn-btn hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            连接
          </button>
        </div>
      </div>

      <div class="bg-gray-50 hand-drawn-border p-4 mb-6">
        <div id="grid" class="grid grid-cols-10 gap-2 mb-4"></div>

        <div class="flex flex-wrap gap-3">
          <button id="btnB"
            class="bg-indigo-600 text-white px-4 py-2 hand-drawn-btn hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            庄 (B)
          </button>
          <button id="btnP"
            class="bg-pink-500 text-white px-4 py-2 hand-drawn-btn hover:bg-pink-600 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2">
            闲 (P)
          </button>
          <button id="btnUndo"
            class="bg-gray-500 text-white px-4 py-2 hand-drawn-btn hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
            撤销
          </button>
          <button id="btnReset"
            class="bg-gray-500 text-white px-4 py-2 hand-drawn-btn hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
            重置
          </button>
          <button id="btnPredict"
            class="bg-green-600 text-white px-4 py-2 hand-drawn-btn hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
            预测
          </button>
        </div>

        <div id="trainStatus" class="mt-3 text-sm text-gray-600">
          <span class="font-medium">模型训练状态:</span> <span>等待数据输入...</span>
        </div>
      </div>

      <div class="bg-indigo-50 hand-drawn-border p-4 mb-6">
        <h2 class="text-xl font-bold text-indigo-700 mb-3">预测结果</h2>
        <div id="resultContainer" class="text-center">
          <div id="resultText" class="text-2xl font-bold mb-2 text-gray-500">等待预测...</div>
          <div id="confidenceText" class="text-sm text-gray-600">参考度: --%</div>
        </div>
      </div>

      <div class="text-xs text-gray-500 text-center">
        以上内容由AI搜集并生成，仅供参考
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {

      // ✅ 你的 Supabase（已经写好）
      const SUPABASE_URL = "https://nljvpnmcnzeibosrtnlp.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_zvkqWardciRVVm4PpzU6Lg_FTZbeqJ3";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ✅ 你 Supabase 里建的表名（必须一致）
      const TABLE_NAME = "baccarat_history"; // 列：result（文本） + created_at（时间戳） + id（自增）

      const apiKeyInput = document.getElementById('apiKeyInput');
      const btnConnect = document.getElementById('btnConnect');
      const connectionStatus = document.getElementById('connectionStatus');
      const grid = document.getElementById('grid');
      const btnB = document.getElementById('btnB');
      const btnP = document.getElementById('btnP');
      const btnUndo = document.getElementById('btnUndo');
      const btnReset = document.getElementById('btnReset');
      const btnPredict = document.getElementById('btnPredict');
      const trainStatus = document.getElementById('trainStatus');
      const resultText = document.getElementById('resultText');
      const confidenceText = document.getElementById('confidenceText');

      let isConnected = false;

      // 这里用 records 存（包含 id，方便撤销/删除）
      let records = []; // [{id, result}]

      function initializeGrid() {
        grid.innerHTML = '';
        for (let i = 0; i < 100; i++) {
          const cell = document.createElement('div');
          cell.className = 'cell h-8 flex items-center justify-center bg-gray-200 rounded';
          grid.appendChild(cell);
        }
      }

      function updateTrainStatus() {
        if (records.length > 0) {
          trainStatus.innerHTML = `<span class="font-medium">模型训练状态:</span> <span class="text-green-600">已收集 ${records.length} 条数据（云端记忆）</span>`;
        } else {
          trainStatus.innerHTML = `<span class="font-medium">模型训练状态:</span> <span>等待数据输入...</span>`;
        }
      }

      function updateGrid() {
        const cells = grid.querySelectorAll('.cell');
        cells.forEach((cell, index) => {
          if (index < records.length) {
            const v = records[index].result;
            cell.textContent = v;
            cell.className = `cell h-8 flex items-center justify-center rounded font-bold ${v === 'B' ? 'bg-indigo-500 text-white' : 'bg-pink-500 text-white'}`;
          } else {
            cell.textContent = '';
            cell.className = 'cell h-8 flex items-center justify-center bg-gray-200 rounded';
          }
        });
        updateTrainStatus();
      }

      function setConnectedUI() {
        isConnected = true;
        connectionStatus.textContent = '已连接';
        connectionStatus.className = 'px-3 py-1 rounded-full text-xs font-bold uppercase bg-green-100 text-green-800';

        btnConnect.disabled = true;
        btnConnect.textContent = '已连接';
        btnConnect.className = 'absolute right-2 top-1/2 transform -translate-y-1/2 bg-green-600 text-white px-4 py-1 rounded-lg hand-drawn-btn focus:outline-none';

        btnPredict.disabled = false;
      }

      function setDisconnectedUI() {
        isConnected = false;
        connectionStatus.textContent = '未连接';
        connectionStatus.className = 'px-3 py-1 rounded-full text-xs font-bold uppercase bg-red-100 text-red-800';

        btnConnect.disabled = false;
        btnConnect.textContent = '连接';
        btnConnect.className = 'absolute right-2 top-1/2 transform -translate-y-1/2 bg-indigo-600 text-white px-4 py-1 rounded-lg hand-drawn-btn hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2';

        btnPredict.disabled = true;
      }

      async function loadHistoryFromDB() {
        const { data, error } = await supabase
          .from(TABLE_NAME)
          .select('id,result,created_at')
          .order('id', { ascending: true })
          .limit(1000);

        if (error) throw error;

        records = (data || []).map(r => ({ id: r.id, result: r.result }));
        updateGrid();
      }

      async function insertResultToDB(result) {
        const { data, error } = await supabase
          .from(TABLE_NAME)
          .insert({ result })
          .select('id,result')
          .single();

        if (error) throw error;
        return data;
      }

      async function deleteById(id) {
        const { error } = await supabase
          .from(TABLE_NAME)
          .delete()
          .eq('id', id);

        if (error) throw error;
      }

      async function connectToSupabase() {
        btnConnect.disabled = true;
        btnConnect.innerHTML = '<span class="animate-pulse">连接中...</span>';

        try {
          // 测试连接：读一次（如果表存在并且允许 select，就算成功）
          await loadHistoryFromDB();
          setConnectedUI();
        } catch (e) {
          alert('连接失败：请确认 Supabase 表名/权限是否正确。\n\n' + (e && e.message ? e.message : e));
          setDisconnectedUI();
        }
      }

      // 统计预测：用“最后 N 位”做马尔可夫统计（N=4）
      function predictByHistory() {
        const history = records.map(r => r.result);
        const minNeed = 5;

        if (history.length < minNeed) {
          return { pick: null, confidence: 0, reason: '数据不足' };
        }

        const N = 4;
        const key = history.slice(-N).join('');

        let countB = 0, countP = 0;

        // 统计：出现 key 后下一位是 B 还是 P
        for (let i = 0; i + N < history.length; i++) {
          const k = history.slice(i, i + N).join('');
          if (k === key) {
            const next = history[i + N];
            if (next === 'B') countB++;
            if (next === 'P') countP++;
          }
        }

        // 如果匹配太少，用总体比例兜底
        if (countB + countP < 3) {
          const totalB = history.filter(x => x === 'B').length;
          const totalP = history.length - totalB;
          const pick = totalB >= totalP ? 'B' : 'P';
          const conf = Math.round((Math.max(totalB, totalP) / history.length) * 100);
          return { pick, confidence: Math.min(95, Math.max(55, conf)), reason: '总体比例' };
        }

        const pick = countB >= countP ? 'B' : 'P';
        const conf = Math.round((Math.max(countB, countP) / (countB + countP)) * 100);
        return { pick, confidence: Math.min(95, Math.max(55, conf)), reason: `基于末${N}位匹配统计` };
      }

      async function predictNext() {
        if (!isConnected) {
          alert('请先连接（连接按钮）');
          return;
        }

        if (records.length < 5) {
          alert('至少需要 5 条历史数据才能预测');
          return;
        }

        btnPredict.disabled = true;
        btnPredict.innerHTML = '<span class="animate-pulse">预测中...</span>';
        resultText.textContent = "分析中...";
        resultText.className = "text-2xl font-bold mb-2 text-indigo-500";
        confidenceText.textContent = "计算参考度...";
        confidenceText.className = "text-sm text-gray-600";

        try {
          // ✅ 模拟“分析中…”的等待（你之前说要等一会儿）
          await new Promise(r => setTimeout(r, 1500));

          const r = predictByHistory();
          const pred = r.pick;
          const conf = r.confidence;

          resultText.textContent = pred === 'B' ? "庄 (B)" : "闲 (P)";
          resultText.className = `text-2xl font-bold mb-2 ${pred === 'B' ? 'text-indigo-600' : 'text-pink-600'}`;

          confidenceText.textContent = `参考度: ${conf}%（${r.reason}）`;
          confidenceText.className = `text-sm ${conf >= 85 ? 'text-green-600' : (conf >= 70 ? 'text-yellow-600' : 'text-gray-600')}`;

        } catch (e) {
          alert('预测失败：' + (e && e.message ? e.message : e));
          resultText.textContent = "预测失败";
          resultText.className = "text-2xl font-bold mb-2 text-red-500";
          confidenceText.textContent = "请检查连接后重试";
          confidenceText.className = "text-sm text-red-500";
        } finally {
          btnPredict.disabled = false;
          btnPredict.textContent = '预测';
        }
      }

      // 点击 B / P：写入云端 + 刷新网格
      async function addResult(result) {
        if (!isConnected) {
          alert('请先连接（连接按钮）');
          return;
        }
        try {
          const row = await insertResultToDB(result);
          records.push({ id: row.id, result: row.result });

          // 只保留 100 格
          if (records.length > 100) records = records.slice(records.length - 100);

          updateGrid();
        } catch (e) {
          alert('写入数据库失败：' + (e && e.message ? e.message : e));
        }
      }

      async function undoLast() {
        if (!isConnected) {
          alert('请先连接（连接按钮）');
          return;
        }
        if (records.length === 0) return;

        const last = records[records.length - 1];
        try {
          if (last && last.id) {
            await deleteById(last.id);
          }
          records.pop();
          updateGrid();
        } catch (e) {
          alert('撤销失败：' + (e && e.message ? e.message : e));
        }
      }

      async function resetAll() {
        if (!isConnected) {
          alert('请先连接（连接按钮）');
          return;
        }

        const ok = confirm('确定要重置吗？会清空当前页面的记录（并尝试清空云端表数据）。');
        if (!ok) return;

        resultText.textContent = "等待预测...";
        resultText.className = "text-2xl font-bold mb-2 text-gray-500";
        confidenceText.textContent = "参考度: --%";
        confidenceText.className = "text-sm text-gray-600";

        // 尝试清空云端（如果你表是 UNRESTRICTED/或RLS允许，会成功）
        try {
          await supabase.from(TABLE_NAME).delete().neq('id', 0);
        } catch (e) {
          // 如果清空云端失败，也不影响本地清空
        }

        records = [];
        updateGrid();
      }

      // 事件
      btnConnect.addEventListener('click', connectToSupabase);
      btnB.addEventListener('click', () => addResult('B'));
      btnP.addEventListener('click', () => addResult('P'));
      btnUndo.addEventListener('click', undoLast);
      btnReset.addEventListener('click', resetAll);
      btnPredict.addEventListener('click', predictNext);

      // 初始化
      initializeGrid();
      btnPredict.disabled = true;
      setDisconnectedUI();
    });
  </script>
</body>
</html>
