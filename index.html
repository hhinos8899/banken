<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>方案 C · 下一把到来才解锁播报</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;background:#0b0c0f;color:#e9eef8;font-family:system-ui}
.wrap{max-width:960px;margin:24px auto;padding:0 14px}
.btn{padding:10px 14px;border-radius:12px;border:1px solid #333;background:#111;color:#eee;font-weight:700;cursor:pointer}
.btn:hover{background:#1a1a1a}
.btn.red{border-color:#553;color:#fbb}
.panel{border:1px solid #222;background:#111;border-radius:16px;padding:16px;margin-top:12px}
.big{font-size:36px;font-weight:900;text-align:center;padding:18px;border-radius:14px}
.big.ok{background:#123;color:#2ee08a}
.big.no{background:#200;color:#ff6b6b}
.row{display:flex;gap:10px;flex-wrap:wrap}
.mono{font-family:ui-monospace,Consolas,monospace}
.small{font-size:13px;color:#aaa}
.box{border:1px solid #222;border-radius:12px;padding:12px;margin-top:10px}
</style>
</head>

<body>
<div class="wrap">
<h2>方案 C · 下一把到来才解锁播报</h2>

<div class="row">
  <button class="btn" onclick="add('B')">录入 B</button>
  <button class="btn" onclick="add('P')">录入 P</button>
  <button class="btn" onclick="add('T')">录入 T</button>
  <button class="btn" onclick="undo()">撤销</button>
  <button class="btn red" onclick="resetAll()">清空</button>
</div>

<div class="panel">
  <div id="banner" class="big no">现在：不要动</div>
  <div class="small" id="reason" style="margin-top:10px"></div>
</div>

<div class="box">
  <div class="small">最近 6 把（只算 B / P）：</div>
  <div class="mono" id="recent">不足</div>
</div>

<div class="box">
  <div class="small">完整历史：</div>
  <div class="mono" id="history">（空）</div>
</div>
</div>

<script>
/* ===== 参数 ===== */
const SUB_WINDOW = 6;
const THRESHOLD = 4;

/* ===== 状态 ===== */
let history = [];
let used = false;       // 本结构期已用过一次“可以动”
let inStruct = false;   // 当前处于结构期（曾出现过dir）

/* ===== “下一把到来才解锁”用到的状态 ===== */
let prevRecentKey = "";

/* ===== 女声 TTS（Edge）===== */
let voice = null;
function pickVoice(){
  const v = speechSynthesis.getVoices();
  voice =
    v.find(x=>/Xiaoxiao|Huihui/i.test(x.name) && /zh/i.test(x.lang)) ||
    v.find(x=>/zh/i.test(x.lang)) ||
    null;
}
pickVoice();
setTimeout(pickVoice,200);
setTimeout(pickVoice,800);
speechSynthesis.onvoiceschanged = pickVoice;

function speak(text){
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  if(voice) u.voice = voice;
  u.rate = 1.0;
  u.pitch = 1.1;
  speechSynthesis.speak(u);
}

/* ===== 工具 ===== */
function lastBP(){
  return history.filter(x=>x==="B"||x==="P").slice(-SUB_WINDOW);
}
function countBP(arr){
  return {b:arr.filter(x=>x==="B").length,p:arr.filter(x=>x==="P").length};
}

/* ===== 操作 ===== */
function add(x){
  speechSynthesis.resume();
  history.push(x);
  render();
}
function undo(){
  history.pop();
  // 撤销后重新渲染即可；别强行重置used，让逻辑自然跟随当前窗口
  render();
}
function resetAll(){
  history=[];
  used=false;
  inStruct=false;
  prevRecentKey="";
  render();
}

/* ===== 核心逻辑 ===== */
function render(){
  const banner = document.getElementById("banner");
  const reason = document.getElementById("reason");

  document.getElementById("history").textContent = history.join("")||"（空）";

  const recent = lastBP();
  document.getElementById("recent").textContent =
    recent.length<6 ? "不足" : recent.join("");

  // 生成“最近6把”的key（只在满6把时有效）
  const recentKey = (recent.length === 6) ? recent.join("") : "";

  // ✅ 解锁播报：必须“上一轮用过一次(used=true)”，且“下一把真的来了(最近6把变化)”
  if (used && prevRecentKey && recentKey && recentKey !== prevRecentKey) {
    speak("结构已解锁");
    used = false;
    inStruct = false;
  }
  if (recentKey) prevRecentKey = recentKey;  // 只有满6把才更新key
  if (!recentKey) prevRecentKey = "";        // 不足6把时清空，避免乱触发

  if(recent.length<6){
    banner.className="big no";
    banner.textContent="现在：不要动";
    reason.textContent="数据不足";
    return;
  }

  const {b,p}=countBP(recent);
  let dir=null;
  if(b>=THRESHOLD) dir="B";
  if(p>=THRESHOLD) dir="P";

  if(dir){
    inStruct=true;
    if(!used){
      banner.className="big ok";
      banner.textContent="可以动："+dir;
      reason.textContent=`最近6把=${recent.join("")}  B=${b} P=${p}`;
      setTimeout(()=>speak("可以动，下注 " + dir),250);
      used=true;
    }else{
      banner.className="big no";
      banner.textContent="现在：不要动";
      reason.textContent="本结构期已用过一次";
    }
  }else{
    banner.className="big no";
    banner.textContent="现在：不要动";
    reason.textContent="未达 4/6 阈值";
  }
}
</script>
</body>
</html>
