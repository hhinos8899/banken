<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>方案 C · 自动解锁播报版</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;background:#0b0c0f;color:#e9eef8;font-family:system-ui}
.wrap{max-width:960px;margin:24px auto;padding:0 14px}
.btn{padding:10px 14px;border-radius:12px;border:1px solid #333;background:#111;color:#eee;font-weight:700;cursor:pointer}
.btn:hover{background:#1a1a1a}
.btn.red{border-color:#553;color:#fbb}
.panel{border:1px solid #222;background:#111;border-radius:16px;padding:16px;margin-top:12px}
.big{font-size:36px;font-weight:900;text-align:center;padding:18px;border-radius:14px}
.big.ok{background:#123;color:#2ee08a}
.big.no{background:#200;color:#ff6b6b}
.row{display:flex;gap:10px;flex-wrap:wrap}
.mono{font-family:ui-monospace,Consolas,monospace}
.small{font-size:13px;color:#aaa}
.box{border:1px solid #222;border-radius:12px;padding:12px;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
<h2>方案 C · 自动解锁 + 女声播报</h2>

<div class="row">
  <button class="btn" onclick="add('B')">录入 B</button>
  <button class="btn" onclick="add('P')">录入 P</button>
  <button class="btn" onclick="add('T')">录入 T</button>
  <button class="btn" onclick="undo()">撤销</button>
  <button class="btn red" onclick="resetAll()">清空</button>
</div>

<div class="panel">
  <div id="banner" class="big no">现在：不要动</div>
  <div class="small" id="reason" style="margin-top:10px"></div>
</div>

<div class="box">
  <div class="small">最近 6 把（只算 B / P）：</div>
  <div class="mono" id="recent">不足</div>
</div>

<div class="box">
  <div class="small">完整历史：</div>
  <div class="mono" id="history">（空）</div>
</div>
</div>

<script>
/* ===== 参数 ===== */
const SUB_WINDOW = 6;
const THRESHOLD = 4;

/* ===== 状态 ===== */
let history = [];
let used = false;
let inStruct = false;

/* ===== 解锁播报状态（关键） ===== */
let lastBannerText = "";
let lastSaidUnlock = false;

/* ===== 女声（Edge 中文）===== */
let voice = null;
function pickVoice(){
  const v = speechSynthesis.getVoices();
  voice =
    v.find(x=>/Xiaoxiao|Huihui/i.test(x.name) && /zh/i.test(x.lang)) ||
    v.find(x=>/zh/i.test(x.lang)) ||
    null;
}
speechSynthesis.onvoiceschanged = pickVoice;
pickVoice();

function speak(text){
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  if(voice) u.voice = voice;
  u.rate = 1.0;
  u.pitch = 1.1;
  speechSynthesis.speak(u);
}

/* ===== 逻辑 ===== */
function lastBP(){
  return history.filter(x=>x==="B"||x==="P").slice(-SUB_WINDOW);
}
function countBP(arr){
  return {b:arr.filter(x=>x==="B").length,p:arr.filter(x=>x==="P").length};
}

function add(x){
  speechSynthesis.resume();
  history.push(x);
  render();
}

function undo(){
  history.pop();
  used=false;
  inStruct=false;
  render();
}

function resetAll(){
  history=[];
  used=false;
  inStruct=false;
  lastBannerText="";
  lastSaidUnlock=false;
  render();
}

function render(){
  document.getElementById("history").textContent = history.join("")||"（空）";

  const recent = lastBP();
  document.getElementById("recent").textContent =
    recent.length<6 ? "不足" : recent.join("");

  const banner = document.getElementById("banner");
  const reason = document.getElementById("reason");

  if(recent.length<6){
    banner.className="big no";
    banner.textContent="现在：不要动";
    reason.textContent="数据不足";
  } else {
    const {b,p}=countBP(recent);
    let dir=null;
    if(b>=THRESHOLD) dir="B";
    if(p>=THRESHOLD) dir="P";

    if(dir){
      inStruct=true;
      if(!used){
        banner.className="big ok";
        banner.textContent="可以动："+dir;
        reason.textContent=`最近6把=${recent.join("")}  B=${b} P=${p}`;
        setTimeout(()=>speak("可以动，下注 " + dir),250);
        used=true;
      }else{
        banner.className="big no";
        banner.textContent="现在：不要动";
        reason.textContent="本结构期已用过一次";
      }
    }else{
      banner.className="big no";
      banner.textContent="现在：不要动";
      reason.textContent="未达 4/6 阈值";
    }
  }

  /* ===== 自动解锁播报（和昨天一致）===== */
  const nowText = banner.textContent;
  if(
    lastBannerText.startsWith("可以动") &&
    nowText === "现在：不要动"
  ){
    if(!lastSaidUnlock){
      speak("结构已解锁");
      lastSaidUnlock=true;
      used=false;
      inStruct=false;
    }
  }else{
    lastSaidUnlock=false;
  }
  lastBannerText = nowText;
}
</script>
</body>
</html>
